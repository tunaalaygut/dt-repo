<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5">

<div th:replace="fragments/fragments :: head(content = 'Toplantı Talep Formu')"></div>

<body>

<div class="wrapper">
	<div th:replace="fragments/fragments :: sidebar"></div>
		<div class="content">
            <div th:replace="fragments/fragments :: navbar"></div>
            <h2 class="mb-4">Toplantı Talep Formu</h2>

			<!--MEETING_REQUEST_FORM BEGINS-->
            <form th:action="@{/add/meetingRequest}" th:object="${addMeetingRequestForm}" th:method="post" autocomplete="off" id="requestMeeting">
				<!--TIME INFO STARTS-->
				<div class="row">
					<div class="col-md-6">
						<div class="form-group">
							<label>Toplantı Tarihi:</label>
							<input type="date" th:field="*{date}" class="form-control" placeholder="Toplantı Tarihi" id="datePicker"/>
						</div>
					</div>
					<div class="col-md-6">
						<div class="row">
							<div class="col-sm-6">
								<div class="form-group">
									<label for="beginningTimeInput">Başlangıç Saati:</label>
									<select  th:field="*{beginningTime}" class="custom-select" id="beginningTimeInput">
										<option th:each="time : ${addMeetingRequestForm.times}" th:value="${time}" th:text="${time}">
										</option>
									</select>
								</div>
							</div>
							<div class="col-sm-6">
								<div class="form-group">
									<label for="endTimeInput">Bitiş Saati:</label>
									<select th:field="*{endTime}" class="custom-select" id="endTimeInput">
										<option th:each="time : ${addMeetingRequestForm.times}" th:value="${time}" th:text="${time}">
										</option>
									</select>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!--TIME INFO ENDS-->


				<!--LOGISTICS START HERE-->
				<div class="row">
					<div class="col-sm-6">
						<div class="form-group">
							<label for="buildingId">Bina:</label>
							<select th:field="*{buildingId}" class="custom-select" id="buildingId">
								<option th:each="building : *{allBuildings}" th:value="${building.buildingId}" th:text="${building.buildingName}">
								</option>
							</select>
						</div>
					</div>
					<div class="col-sm-6">
						<div class="form-group">
							<label for="meetingRoomId">Toplantı Odası</label>
							<select th:field="*{meetingRoomId}" class="custom-select" id="meetingRoomId">
								<!--<option th:each="meetingRoom : *{allMeetingRooms}" th:value="${meetingRoom.meetingRoomId}" th:text="${meetingRoom.meetingRoomName}">
								</option>-->
								<option value="0">-</option>
							</select>
						</div>
					</div>
				</div>
				<!--LOGISTICS END HERE-->


				<!--PARTICIPANTS START HERE-->
				<div class="row my-5">
					<div class="col-sm-6">
						<div class="row">
							<div class="col">
                                <div class="form-group">
                                    <label>Katılımcı Ekle:</label>
                                    <div class="table-responsive">
                                        <table class="table" id="example">
                                            <thead>
                                            <tr>
                                                <th scope="col">İsim</th>
                                                <th scope="col">E-mail</th>
                                                <th scope="col">Ekle</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <tr th:each="member : *{allMembers}">
                                                <td th:text="${member.firstName + ' ' + member.lastName}"></td>
                                                <td th:text="${member.email}"></td>
                                                <td class="text-center">
                                                    <button type="button" th:attr="value0=${member.memberId}, value1=${member.firstName + ' ' + member.lastName}, value2=${member.email}" class="btn btn-outline-info btn-sm addMember" style="border-radius:50%;">
                                                        <span class="fas fa-plus"></span>
                                                    </button>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
							</div>
						</div>
						<div class="row">
							<div class="col">
								<div class="form-group">
									<label for="guestFullNameInput">Misafir Adı Soyadı:</label>
									<input type="text" class="form-control" id="guestFullNameInput" aria-describedby="emailHelp" placeholder="Ad Soyad">
								</div>
								<div class="form-group">
									<label for="guestEmailInput">E-mail:</label>
									<input type="email" class="form-control" id="guestEmailInput" placeholder="E-mail">
								</div>
								<button type="button" class="btn btn-info btn-block" id="addGuest">Misafir Katılımcı Ekle</button>
							</div>
						</div>
					</div>
					<div class="col-sm-6">
						<div class="row">
							<div class="col">

								<div class="form-group">
									<label>Eklenen Katımlıcılar:</label>
									<div class="table-responsive">
										<table class="table" id="example2">
											<thead>
											<tr>
												<th scope="col">İsim</th>
												<th scope="col">E-mail</th>
												<th scope="col">Ekle</th>
											</tr>
											</thead>
											<tbody id="addedMembersBody">
												<!--HTML WILL BE INSERTED BY JAVASCRIPT-->
											</tbody>
										</table>
									</div>
								</div>
								<div class="alert alert-warning" id="capacityWarning" role="alert" style="display: none">
									<!--capacity warning-->
								</div>

							</div>
						</div>
					</div>
				</div>

				<!--HIDDEN PARTICIPANT INPUT-->
				<select multiple th:attr="name=participantDetails" id="addedMembersMultipleSelect" style="display: none;">
					<!-- <option value="memberId" selected></option> -->
					<!-- append this option here -->
				</select>
				<!--HIDDEN PARTICIPANT INPUT ENDS HERE-->

				<!--DESCRIPTION STARTS HERE-->
				<div class="form-group">
					<label for="meetingTypeSelectMenu">Toplantı Türü:</label>
					<select class="custom-select" id="meetingTypeSelectMenu" th:field="*{meetingTypeId}">
						<option th:each="type : ${addMeetingRequestForm.allMeetingTypes}" th:text="${type?.meetingTypeName}" th:value = "${type?.meetingTypeId}"></option>
					</select>
			  	</div>

				<div class="form-group">
					<label for="descriptionInput">Açıklama:</label>
					 <textarea th:field="*{description}" type="text" class="form-control" id="descriptionInput" placeholder="Açıklama" rows="3" style="resize: none;"></textarea>
				</div>
				<!--DESCRIPTION ENDS HERE-->

				<div th:replace="fragments/fragments :: creatorIdInput"></div>
				<!--FEEDBACK_MESSAGES_START_HERE-->
				<div th:if="${#fields.hasErrors('date')}" th:errors="*{date}" class="alert alert-danger alert-dismissible fade show" role="alert"></div>
				<div th:if="${#fields.hasErrors('beginningTime')}" th:errors="*{beginningTime}" class="alert alert-danger alert-dismissible fade show" role="alert"></div>
				<div th:if="${#fields.hasErrors('endTime')}" th:errors="*{endTime}" class="alert alert-danger alert-dismissible fade show" role="alert"></div>
				<div th:if="${#fields.hasErrors('description')}" th:errors="*{description}" class="alert alert-danger alert-dismissible fade show" role="alert"></div>
				<!--FEEDBACK_MESSAGES_END_HERE-->
        		<button type="submit" class="btn btn-primary btn-info btn-block mt-5">Toplantı İsteği Oluştur</button>
    		</form>
		</div>
    </div>
   <div th:replace="fragments/fragments :: scripts"></div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-chained/1.0.1/jquery.chained.remote.min.js" integrity="sha256-s4fvhjtBM8Qdr848fG5m3T6LjoJl799Qax4fr/24r30=" crossorigin="anonymous"></script>
	<script type="text/javascript">

		let meetingRoomCapacity;

		function getAndPopulateMeetingRooms(){
			let buildingId = $("#buildingId").val();
			let meetingRoomSelect = $("#meetingRoomId");

			$.ajax({
				url: "[[@{/getBuildingMeetingRooms}]]",
				data : {"buildingId" : buildingId}
			}).done(function(map) {
				meetingRoomSelect.empty();
				$.each(map, function(meetingRoomId, meetingRoomName)
				{
					console.log(meetingRoomId, meetingRoomName);
					meetingRoomSelect.append('<option value=' + meetingRoomId + '>' + meetingRoomName + '</option>');
				});
			});
		}

		function checkRoomCapacity(){
			let addedMemberCount = $('#example2').DataTable().rows().count();
			console.log(addedMemberCount + " people on the datatable.");

			if (addedMemberCount > meetingRoomCapacity){
				$("#capacityWarning").css("display", "block");
				$("#capacityWarning").text("Toplantı odasının kapasitesi " + meetingRoomCapacity + " kişi olarak belirlenmiştir.(" + addedMemberCount + " kişi eklendi.)");
			}
			else
				$("#capacityWarning").css("display", "none");
		}

		function getRoomCapacity(){
			let meetingRoomId = $("#meetingRoomId").val();

			$.ajax({
				url: "[[@{/getMeetingRoomCapacity}]]",
				data : {"meetingRoomId" : meetingRoomId}
			}).done(function(capacity) {
				meetingRoomCapacity = capacity;
				console.log(meetingRoomCapacity);
			});

		}

		$("#buildingId").change(function(){
			getAndPopulateMeetingRooms();
		});

		$("#meetingRoomId").change(function (){
			meetingRoomCapacity = getRoomCapacity();
		});

		$( document ).ready(function() {
			getAndPopulateMeetingRooms();
			meetingRoomCapacity = getRoomCapacity();
		});



		$(document).on('click','.addMember', function() {
			let clickedMemberId = $(this).attr("value0");
			let memberName = $(this).attr("value1");
			let email = $(this).attr("value2");

			transferParticipantInfo(clickedMemberId, memberName, email);
			checkRoomCapacity();
		});

		$(document).on('click','#addGuest', function(){
			let guestFullNameInput = $("#guestFullNameInput");
			let guestEmailInput = $("#guestEmailInput");
			let guestFullName = guestFullNameInput.val();
			let guestEmail = guestEmailInput.val();


			if ((guestFullName !== "") && (guestEmail !== "")) {
				//Clear inputs in the add guest form.
				guestFullNameInput.val('');
				guestEmailInput.val('');

				transferParticipantInfo("", guestFullName, guestEmail);
			}
			checkRoomCapacity();
		});

		$(document).on('click','.deleteParticipant', function(){
			let addedMembersDataTable = $('#example2').DataTable();
			let allMembersTable = $('#example').DataTable();

			let clickedRow = $(this).parent().parent();
			let memberId = $(this).attr('value0');
			let fullName = $(this).attr('value1');
			let email = $(this).attr('value2');

			console.log(memberId + " " + fullName + " " + email);

			if(memberId) {
				let newMarkup = $($.parseHTML(
						'<tr>' +
						'<td>' + fullName + '</td>' +
						'<td>' + email + '</td>' +
						'<td class="text-center">' +
						'<button type="button" value0="' + memberId + '" value1="' + fullName + '" value2="' + email + '" class="btn btn-sm btn-outline-info addMember" style="border-radius: 50%;">' +
						'<span class="fas fa-plus"></span>' +
						'</button>' +
						'</td>' +
						'</tr>'));

				allMembersTable.row.add(newMarkup).draw();
			}


			addedMembersDataTable.rows(clickedRow).remove().draw();
			removeParticipant(memberId, fullName, email);
			checkRoomCapacity();
		});

		function addParticipant(memberId, fullName, email){
			let addedMembers = $("#addedMembersMultipleSelect");
			let markup =
					'<option value="'+ memberId +'" selected></option>' +
					'<option value="'+ fullName +'" selected></option>' +
					'<option value="'+ email +'" selected></option>';
			markup = $($.parseHTML(markup));

			addedMembers.append(markup);
		}

		function  removeParticipant(memberId, fullName, email) {
			let addedMembers = $("#addedMembersMultipleSelect");
			let emailOption = $('option[value="'+ email +'"]');
			let fullNameOption = emailOption.prev();
			let memberIdOption = fullNameOption.prev();

			emailOption.remove();
			fullNameOption.remove();
			memberIdOption.remove();
		}

		function transferParticipantInfo(memberId, fullName, email){
			let addedMembersDataTable = $('#example2').DataTable();
			let allMembersTable = $('#example').DataTable();
			let newMarkup;

			if(memberId){
				newMarkup = $($.parseHTML(
						'<tr>' +
						'<td>' + fullName + '</td>' +
						'<td>' + email + '</td>' +
						'<td class="text-center">' +
						'<button type="button" value0="'+ memberId +'" value1="'+ fullName +'" value2="'+ email +'" class="btn btn-sm btn-outline-danger deleteParticipant" style="border-radius: 50%;">' +
						'<span class="fas fa-minus"></span>' +
						'</button>' +
						'</td>' +
						'</tr>'));
				let memberButton = $('button[value0='+ memberId +']');
				allMembersTable.rows(memberButton.parent().parent()).remove().draw();
			}
			else
				newMarkup = $($.parseHTML(
						'<tr>' +
						'<td>' + fullName + '<small class="text-muted"> (Misafir)</small></td>' +
						'<td>' + email + '</td>' +
						'<td class="text-center">' +
						'<button type="button" value0="" value1="'+ fullName +'" value2="'+ email +'" class="btn btn-sm btn-outline-danger deleteParticipant" style="border-radius: 50%;">' +
						'<span class="fas fa-minus"></span>' +
						'</button>' +
						'</td>' +
						'</tr>'));


			addParticipant(memberId, fullName, email);
			addedMembersDataTable.row.add(newMarkup).draw();			//update added members table
		}


	</script>
</body>
</html>
